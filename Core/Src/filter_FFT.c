#include "filter.h"
#include "arm_math.h"
#include "arm_const_structs.h"

//Example for keil -- C:\Users\bat\AppData\Local\Arm\Packs\ARM\CMSIS\5.6.0\CMSIS\DSP\Examples\ARM\arm_fft_bin_example

//синусоида 50 Гц + шум
/*int16_t testInput_q15[LENGTH_SAMPLES] =
{
	12434, 0, -10019, 0, 16296, 0, -32, 0, 2127, 0, -10826, 0, -13, 0, 1327, 0, 1030, 0, -14353, 0, 1709, 0, -4162, 0, 3812, 0, 3013, 0, -2067, 0, 4900, 0, 9078, 0, -296, 0, 1178, 0, -9776, 0, -10397, 0, 8122, 0, 3920, 0, -136, 0, 1814, 0, 902, 0, 4082, 0, 11733, 0, 6512, 0, -2040, 0, -7408, 0, -2623, 0, 11420, 0, -8523, 0, -3317, 0, -15487, 0, 7069, 0, 9346, 0, 1938, 0, -3186, 0, -19060, 0, 3772, 0, -9551, 0, -11810, 0, -1785, 0, -9801, 0, 2127, 0, 7862, 0, 8166, 0, -5998, 0, -1315, 0, -377, 0, 8481, 0, 6584, 0, 4328, 0, -4902, 0, -2472, 0, 9227, 0, -9435, 0, -3701, 0, -11824, 0, -4456, 0, 6584, 0, 8930, 0, -6236, 0, -6751, 0, 
	-1757, 0, 313, 0, 5872, 0, 3058, 0, -9326, 0, -4121, 0, -11532, 0, 11128, 0, -2676, 0, -10686, 0, -4966, 0, -7782, 0, 3948, 0, -1693, 0, 10484, 0, 3292, 0, -14939, 0, 6685, 0, -6315, 0, -4007, 0, -2910, 0, 4393, 0, 2107, 0, 12435, 0, -4886, 0, -2039, 0, 3285, 0, 4037, 0, 8579, 0, 606, 0, -8914, 0, -12472, 0, 14585, 0, -201, 0, -164, 0, -592, 0, -1233, 0, -2808, 0, 911, 0, -968, 0, 5167, 0, -7729, 0, 7097, 0, 5869, 0, -1035, 0, -10197, 0, -4642, 0, 1219, 0, -4952, 0, 2176, 0, -8458, 0, -3869, 0, 3255, 0, -1467, 0, -204, 0, -884, 0, -14892, 0, 6966, 0, 18913, 0, 8000, 0, -4539, 0, -1223, 0, -6365, 0, 15394, 0, 8378, 0, 2732, 0,
	-9399, 0, 1365, 0, 182, 0, 1122, 0, -5070, 0, -10393, 0, -6772, 0, 2000, 0, -7032, 0, 2738, 0, -4800, 0, 2544, 0, 4553, 0, 6740, 0, -9514, 0, -10242, 0, -5022, 0, 3114, 0, 10855, 0, -1581, 0, 3967, 0, 170, 0, 9145, 0, 4832, 0, -3236, 0, -12615, 0, -2211, 0, 6409, 0, 2298, 0, -1943, 0, -5063, 0, -10251, 0, -2230, 0, 2941, 0, 2212, 0, -3143, 0, -28, 0, 873, 0, 15065, 0, 4357, 0, 8811, 0, -8416, 0, 2834, 0, 2104, 0, 6584, 0, 1898, 0, -17507, 0, -9149, 0, -5448, 0, 5759, 0, 7844, 0, -6099, 0, 3423, 0, 6387, 0, -2849, 0, 1841, 0, -8637, 0, 7210, 0, 2398, 0, 13908, 0, -2612, 0, -235, 0, -2984, 0, -10317, 0, -2017, 0, 4364, 0, 
	-3950, 0, -9908, 0, -2281, 0, 5624, 0, -4912, 0, 2700, 0, -7342, 0, 12109, 0, -2558, 0, 2975, 0, -12241, 0, -8149, 0, -3243, 0, 6439, 0, 8064, 0, -594, 0, -6212, 0, 4809, 0, 8693, 0, 3489, 0, 1579, 0, -1515, 0, -6863, 0, 8180, 0, -872, 0, -5090, 0, -3009, 0, -3269, 0, 2356, 0, 7171, 0, 5633, 0, -5268, 0, 82, 0, 1287, 0, 5195, 0, 2502, 0, -7710, 0, -751, 0, 5969, 0, 4540, 0, 11030, 0, -7442, 0, -7425, 0, -9000, 0, 9670, 0, 6323, 0, -3897, 0, 2230, 0, 2318, 0, 5878, 0, 2261, 0, -332, 0, -2988, 0, 17726, 0, -3151, 0, -9287, 0, -9607, 0, -10574, 0
};*/
extern uint8_t array_numb;
static int16_t testOutput[LENGTH_SAMPLES/2];
__IO int16_t input_50Hz[2][LENGTH_SAMPLES];

uint32_t fftSize = 256;
uint32_t ifftFlag = 0;
uint32_t doBitReverse = 1;
uint32_t testIndex = 0;
uint16_t power_line_50Hz = 0;

void filter_FFT(void) {
	//int16_t maxValue = 0;

	arm_cfft_q15(&arm_cfft_sR_q15_len256, (int16_t*)input_50Hz[array_numb], ifftFlag, doBitReverse);
	arm_cmplx_mag_q15((int16_t*)input_50Hz[array_numb], testOutput, fftSize);
	//arm_max_q15(testOutput, fftSize, &maxValue, &testIndex);
	//при частоте ацп в 256 Гц -- 256 значений собирается за 1с, testOutput[50] - магнитуда в 50 Гц
	//при 5120 (256 * 20) -- 50 / 20 ~ 3, testOutput[3] - магнитуда в 50 Гц
	if(testOutput[2] > testOutput[3])
		power_line_50Hz = testOutput[2];
	else
		power_line_50Hz = testOutput[3];
	/*
	  arm_cfft_f32(&arm_cfft_sR_f32_len256, testInput_f32, ifftFlag, doBitReverse);//Process the data through the CFFT/CIFFT module
	  arm_cmplx_mag_f32(testInput_f32, testOutput, fftSize);//Process the data through the Complex Magnitude Module for calculating the magnitude at each bin
	  arm_max_f32(testOutput, fftSize, &maxValue, &testIndex);// Calculates maxValue and returns corresponding BIN value
	*/
	//выполняется за 30232 циклов МК (0,6 мс)
}

/*static float32_t testOutput[LENGTH_SAMPLES/2];
//синусоида 50 Гц, амплитуда = 1, длина =  1 сек, частота дискретизации = 256 Гц 
//массив длиной fftSize * 2, т.к. действительная и мнимая части занимают вместе 2 элемента
//спектр сигнала testOutput[50] и testOutput[206] = 128
//testOutput[i]=2*testOutput[i]/fftSize;% Нормировка спектра по амплитуде
//testOutput(0)=testOutput(0)/2;% Нормировка постоянной составляющей в спектре
float32_t testInput_f32[LENGTH_SAMPLES] = 
{
	0.0000, 0.0000,0.9415, 0.0000,0.6344, 0.0000,-0.5141, 0.0000,-0.9808, 0.0000,-0.1467, 0.0000,0.8819, 0.0000,0.7410, 0.0000,-0.3827, 0.0000,-0.9988, 0.0000,-0.2903, 0.0000,0.8032, 0.0000,0.8315, 0.0000,-0.2430, 0.0000,-0.9952, 0.0000,-0.4276, 0.0000,0.7071, 0.0000,0.9040, 0.0000,-0.0980, 0.0000,-0.9700, 0.0000,-0.5556, 0.0000,0.5957, 0.0000,0.9569, 0.0000,0.0491, 0.0000,-0.9239, 0.0000,-0.6716, 0.0000,0.4714, 0.0000,0.9892, 0.0000,0.1951, 0.0000,-0.8577, 0.0000,-0.7730, 0.0000,0.3369, 0.0000,1.0000, 0.0000,0.3369, 0.0000,-0.7730, 0.0000,-0.8577, 0.0000,0.1951, 0.0000,0.9892, 0.0000,0.4714, 0.0000,-0.6716, 0.0000,-0.9239, 0.0000,0.0491, 0.0000,0.9569, 0.0000,0.5957, 0.0000,-0.5556, 0.0000,-0.9700, 0.0000,-0.0980, 0.0000,0.9040, 0.0000,0.7071, 0.0000,-0.4276, 0.0000,-0.9952, 0.0000,-0.2430, 0.0000,0.8315, 0.0000,0.8032, 0.0000,-0.2903, 0.0000,-0.9988, 0.0000,-0.3827, 0.0000,0.7410, 0.0000,0.8819, 0.0000,-0.1467, 0.0000,-0.9808, 0.0000,-0.5141, 0.0000,0.6344, 0.0000,0.9415, 0.0000,-0.0000, 0.0000,-0.9415, 0.0000,-0.6344, 0.0000,0.5141, 0.0000,
	0.9808, 0.0000,0.1467, 0.0000,-0.8819, 0.0000,-0.7410, 0.0000,0.3827, 0.0000,0.9988, 0.0000,0.2903, 0.0000,-0.8032, 0.0000,-0.8315, 0.0000,0.2430, 0.0000,0.9952, 0.0000,0.4276, 0.0000,-0.7071, 0.0000,-0.9040, 0.0000,0.0980, 0.0000,0.9700, 0.0000,0.5556, 0.0000,-0.5957, 0.0000,-0.9569, 0.0000,-0.0491, 0.0000,0.9239, 0.0000,0.6716, 0.0000,-0.4714, 0.0000,-0.9892, 0.0000,-0.1951, 0.0000,0.8577, 0.0000,0.7730, 0.0000,-0.3369, 0.0000,-1.0000, 0.0000,-0.3369, 0.0000,0.7730, 0.0000,0.8577, 0.0000,-0.1951, 0.0000,-0.9892, 0.0000,-0.4714, 0.0000,0.6716, 0.0000,0.9239, 0.0000,-0.0491, 0.0000,-0.9569, 0.0000,-0.5957, 0.0000,0.5556, 0.0000,0.9700, 0.0000,0.0980, 0.0000,-0.9040, 0.0000,-0.7071, 0.0000,0.4276, 0.0000,0.9952, 0.0000,0.2430, 0.0000,-0.8315, 0.0000,-0.8032, 0.0000,0.2903, 0.0000,0.9988, 0.0000,0.3827, 0.0000,
	-0.7410, 0.0000,-0.8819, 0.0000,0.1467, 0.0000,0.9808, 0.0000,0.5141, 0.0000,-0.6344, 0.0000,-0.9415, 0.0000,0.0000, 0.0000,0.9415, 0.0000,0.6344, 0.0000,-0.5141, 0.0000,-0.9808, 0.0000,-0.1467, 0.0000,0.8819, 0.0000,0.7410, 0.0000,-0.3827, 0.0000,-0.9988, 0.0000,-0.2903, 0.0000,0.8032, 0.0000,0.8315, 0.0000,-0.2430, 0.0000,-0.9952, 0.0000,-0.4276, 0.0000,0.7071, 0.0000,0.9040, 0.0000,-0.0980, 0.0000,-0.9700, 0.0000,-0.5556, 0.0000,0.5957, 0.0000,0.9569, 0.0000,0.0491, 0.0000,-0.9239, 0.0000,-0.6716, 0.0000,0.4714, 0.0000,0.9892, 0.0000,0.1951, 0.0000,-0.8577, 0.0000,-0.7730, 0.0000,0.3369, 0.0000,1.0000, 0.0000,0.3369, 0.0000,-0.7730, 0.0000,-0.8577, 0.0000,0.1951, 0.0000,0.9892, 0.0000,0.4714, 0.0000,-0.6716, 0.0000,-0.9239, 0.0000,0.0491, 0.0000,0.9569, 0.0000,0.5957, 0.0000,-0.5556, 0.0000,-0.9700, 0.0000,-0.0980, 0.0000,0.9040, 0.0000,0.7071, 0.0000,-0.4276, 0.0000,-0.9952, 0.0000,-0.2430, 0.0000,0.8315, 0.0000,0.8032, 0.0000,-0.2903, 0.0000,-0.9988, 0.0000,-0.3827, 0.0000,0.7410, 0.0000,0.8819, 0.0000,-0.1467, 0.0000,-0.9808, 0.0000,
	-0.5141, 0.0000,0.6344, 0.0000,0.9415, 0.0000,0.0000, 0.0000,-0.9415, 0.0000,-0.6344, 0.0000,0.5141, 0.0000,0.9808, 0.0000,0.1467, 0.0000,-0.8819, 0.0000,-0.7410, 0.0000,0.3827, 0.0000,0.9988, 0.0000,0.2903, 0.0000,-0.8032, 0.0000,-0.8315, 0.0000,0.2430, 0.0000,0.9952, 0.0000,0.4276, 0.0000,-0.7071, 0.0000,-0.9040, 0.0000,0.0980, 0.0000,0.9700, 0.0000,0.5556, 0.0000,-0.5957, 0.0000,-0.9569, 0.0000,-0.0491, 0.0000,0.9239, 0.0000,0.6716, 0.0000,-0.4714, 0.0000,-0.9892, 0.0000,-0.1951, 0.0000,0.8577, 0.0000,0.7730, 0.0000,-0.3369, 0.0000,-1.0000, 0.0000,-0.3369, 0.0000,0.7730, 0.0000,0.8577, 0.0000,-0.1951, 0.0000,-0.9892, 0.0000,-0.4714, 0.0000,0.6716, 0.0000,0.9239, 0.0000,-0.0491, 0.0000,-0.9569, 0.0000,-0.5957, 0.0000,0.5556, 0.0000,0.9700, 0.0000,0.0980, 0.0000,-0.9040, 0.0000,-0.7071, 0.0000,0.4276, 0.0000,0.9952, 0.0000,0.2430, 0.0000,-0.8315, 0.0000,-0.8032, 0.0000,0.2903, 0.0000,0.9988, 0.0000,0.3827, 0.0000,-0.7410, 0.0000,-0.8819, 0.0000,0.1467, 0.0000,0.9808, 0.0000,0.5141, 0.0000,-0.6344, 0.0000,-0.9415, 0.0000
};*/

//синусоида 50 Гц, амплитуда = 4096, длина =  1 сек, частота дискретизации = 256 Гц 
//массив длиной fftSize * 2, т.к. действительная и мнимая части занимают вместе 2 элемента
/*int16_t testInput_q15[LENGTH_SAMPLES] =
{
	0, 0, 3857, 0, 2598, 0, -2106, 0, -4017, 0, -601, 0, 3612, 0, 3035, 0, -1567, 0, -4091, 0, -1189, 0, 3290, 0, 3406, 0, -995, 0, -4076, 0, -1751, 0, 2896, 0, 3703, 0, -401, 0, -3973, 0, -2276, 0, 2440, 0, 3920, 0, 201, 0, -3784, 0, -2751, 0, 1931, 0, 4052, 0, 799, 0, -3513, 0, -3166, 0, 1380, 0, 4096, 0, 1380, 0, -3166, 0, -3513, 0, 799, 0, 4052, 0, 1931, 0, -2751, 0, -3784, 0, 201, 0, 3920, 0, 2440, 0, -2276, 0, -3973, 0, -401, 0, 3703, 0, 2896, 0, -1751, 0, -4076, 0, -995, 0, 3406, 0, 3290, 0, -1189, 0, -4091, 0, -1567, 0, 3035, 0, 3612, 0, -601, 0, -4017, 0, -2106, 0, 2598, 0, 3857, 0, 0, 0, -3857, 0, -2598, 0, 2106, 0, 
	4017, 0, 601, 0, -3612, 0, -3035, 0, 1567, 0, 4091, 0, 1189, 0, -3290, 0, -3406, 0, 995, 0, 4076, 0, 1751, 0, -2896, 0, -3703, 0, 401, 0, 3973, 0, 2276, 0, -2440, 0, -3920, 0, -201, 0, 3784, 0, 2751, 0, -1931, 0, -4052, 0, -799, 0, 3513, 0, 3166, 0, -1380, 0, -4096, 0, -1380, 0, 3166, 0, 3513, 0, -799, 0, -4052, 0, -1931, 0, 2751, 0, 3784, 0, -201, 0, -3920, 0, -2440, 0, 2276, 0, 3973, 0, 401, 0, -3703, 0, -2896, 0, 
	1751, 0, 4076, 0, 995, 0, -3406, 0, -3290, 0, 1189, 0, 4091, 0, 1567, 0, -3035, 0, -3612, 0, 601, 0, 4017, 0, 2106, 0, -2598, 0, -3857, 0, 0, 0, 3857, 0, 2598, 0, -2106, 0, -4017, 0, -601, 0, 3612, 0, 3035, 0, -1567, 0, -4091, 0, -1189, 0, 3290, 0, 3406, 0, -995, 0, -4076, 0, -1751, 0, 2896, 0, 3703, 0, -401, 0, -3973, 0, -2276, 0, 2440, 0, 3920, 0, 201, 0, -3784, 0, -2751, 0, 1931, 0, 4052, 0, 799, 0, -3513, 0, -3166, 0, 1380, 0, 4096, 0, 1380, 0, -3166, 0, -3513, 0, 799, 0, 4052, 0, 1931, 0, -2751, 0, -3784, 0, 201, 0, 3920, 0, 2440, 0, -2276, 0, -3973, 0, -401, 0, 3703, 0, 2896, 0, -1751, 0, -4076, 0, -995, 0, 3406, 0, 
	3290, 0, -1189, 0, -4091, 0, -1567, 0, 3035, 0, 3612, 0, -601, 0, -4017, 0, -2106, 0, 2598, 0, 3857, 0, 0, 0, -3857, 0, -2598, 0, 2106, 0, 4017, 0, 601, 0, -3612, 0, -3035, 0, 1567, 0, 4091, 0, 1189, 0, -3290, 0, -3406, 0, 995, 0, 4076, 0, 1751, 0, -2896, 0, -3703, 0, 401, 0, 3973, 0, 2276, 0, -2440, 0, -3920, 0, -201, 0, 3784, 0, 2751, 0, -1931, 0, -4052, 0, -799, 0, 3513, 0, 3166, 0, -1380, 0, -4096, 0, -1380, 0, 3166, 0, 3513, 0, -799, 0, -4052, 0, -1931, 0, 2751, 0, 3784, 0, -201, 0, -3920, 0, -2440, 0, 2276, 0, 3973, 0, 401, 0, -3703, 0, -2896, 0, 1751, 0, 4076, 0, 995, 0, -3406, 0, -3290, 0, 1189, 0, 4091, 0, 1567, 0, -3035, 0, -3612, 0, 601, 0, 4017, 0, 2106, 0, -2598, 0, -3857, 0
};*/
